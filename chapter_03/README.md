# Chapter 03. 단위 테스트 구조
- - -

### AAA 패턴
* AAA 패턴은 각 테스트를 준비, 실행, 검증이라는 세 부분으로 나눌 수 있다.
* AAA 패턴은 스위트 내 모든 테스트가 단순하고 균일한 구조를 갖는 데 도움이 된다.
* 테스트 주도 개발을 실천할 때, 기능을 개발하기 전에 실패할 테스트를 만들 때는 아직 기능이 어떻게 동작할지 충분히 알지 못한다. 따라서 먼저 기대하는 동작으로 윤곽을 잡은 다음, 이러한 기대에 부응하기 위한 시스템을 어떻게 개발할지 아는 것이 좋다. 

#### AAA 패턴의 구조
* 준비 구절에서는 테스트 대상 시스템(SUT, System Under Test)과 해당 의존성을 원하는 상태로 만든다.
* 실행 구절에서는 SUT에서 메서드를 호출하고 준비된 의존성을 전달하며 출력이 있다면 출력 값을 캡처한다.
* 검증 구절에서는 결과를 검증한다. 결과는 반환 값이나 SUT와 협력자의 최종 상태, SUT가 협력자에 호출한 메서드 등으로 표시될 수 있다.
* Given-When-Then 구조와 AAA 구조의 차이는 없다.
* 테스트를 작성할 때는 준비 구절부터 시작하는 것이 자연스럽지만, 검증 구절로 시작하는 것도 가능한 옵션이다.

### 여러 개의 준비, 실행, 검증 구절 피하기
* 검증 구절로 구분된 여러 개의 실행 구절은 여러 개의 동작 단위를 검증하는 테스트를 뜻한다.
  * 이러한 테스트는 단위 테스트가 아니라 통합 테스트이다.
  * 이러한 구조는 피하는 것이 좋다.
* 실행이 하나면 테스트가 단위 테스트 범주에 있게끔 보장하고, 간단하고, 빠르며, 이해하기 쉽다.
* 일련의 실행과 검증이 포함된 테스트를 보면 리팩터링하고, 각 동작을 고유의 테스트로 도출하는 것이 좋다.

### 테스트 내 if 문 피하기
* if 문이 있는 단위 테스트는 안티 패턴이다.
* 단위 테스트든 통합 테스트든 테스트는 분기가 없는 간단한 일련의 단계여야 한다.
* if 문은 테스트가 한 번에 너무 많은 것을 검증한다는 표시다.

### 각 구절은 얼마나 커야 하는가?
* 일반적으로 준비 구절이 세 구절 중 가장 크며, 실행과 검증을 합친 만큼 클 수도 있다.
  * 그러나 이보다 훨씬 크면, 같은 테스트 클래스 내 비공개 메서드 또는 별도의 팩토리 클래스로 도출하는 것이 좋다.
* 준비 구절에서 코드 재사용에 도움이 되는 두 가지 패턴으로 오브젝트 마더와 테스트 데이터 빌더가 있다.
* 실행 구절은 보통 한 줄이다.
  * 실행 구절이 두 줄 이상인 경우 SUT의 공개 API에 문제가 있을 수 있다.

### 검증 구절에는 검증문이 얼마나 있어야 하는가?
* 단일 동작 단위는 여러 결과를 낼 수 있으며, 하나의 테스트로 그 모든 결과를 평가하는 것이 좋다.
  * 하지만 검증 구절이 너무 커지는 것은 경계해야 한다. (제품 코드에서 추상화가 누락됐을 수 있다.)
* SUT에서 반환된 객체 내에서 모든 속성을 검증하는 대신 객체 클래스 내에 적절한 동등 멤버를 정의하는 것이 좋다. 그러면 단일 검증문으로 객체를 기대값과 비교할 수 있다.

### 테스트 픽스처
* 테스트 픽스처는 테스트 실행 대상 객체다.
* 이 객체는 정규의존성, 즉 SUT로 전달되는 인수다.
* 이러한 객체는 각 테스트 실행 전에 알려진 고정 상태로 유지하기 때문에 동일한 결과를 생성한다. 따라서 픽스처라는 단어가 나왔다.

### 테스트 간의 높은 결합도는 안티 패턴이다.
* 테스트를 수정해도 다른 테스트에 영향을 주어서는 안된다.
  * 테스트는 서로 격리돼 실행해야 한다는 것과 비슷하지만, 테스트의 독립적인 수정과 의미가 미묘하게 다르다.
  * 하지만 둘 다 잘 설계된 테스트의 중요한 특성이다.
* 이 지침을 잘 따르기 위해선 테스트 클래스에 공유 상태를 두지 말아야 한다.

### 더 나은 테스트 픽스처 재사용법
* 테스트 클래스에 비공개 팩토리 메서드를 둔다.
* 공통 초기화 코드를 비공개 팩토리 메서드로 추출해 테스트 코드를 짧게 하면서, 동시에 테스트 진행 상황에 대한 전체 맥락을 유지할 수 있다.
* 비공개 메서드를 충분히 일반화하는 한 테스트가 서로 결합되지 않는다.

### 테스트명 내 테스트 대상 메서드
* 테스트 이름에 SUT의 메서드 이름을 포함하지 않는 것이 좋다.
* 테스트 이름을 지을 때는 엄격한 명명 규칙을 두지 않고, 애플리케이션 동작에 대한 테스트를 이해하기 쉽게 작성하는 것이 중요하다.
  * 테스트 대상 메서드의 이름을 변경할 수도 있고, 이는 SUT 동작에 아무런 영향을 미치지 않는다. 하지만 명명 규칙을 따르게 될 경우에, 테스트 이름을 바꿔야할 수 있다. 따라서 코드를 목표로 테스트명을 작성하는 것보다 동작을 목표로 테스트명을 작성하는 것이 중요하다.
